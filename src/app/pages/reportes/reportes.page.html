<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>游늵 Reportes Anuales</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="container">
    
    <!-- Selector de A침o -->
    <ion-card class="selector-a침o">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="calendar-outline"></ion-icon>
          Seleccionar A침o
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-segment [(ngModel)]="anioSeleccionado" (ionChange)="cambiarAnio($event.detail.value)">
          <ion-segment-button *ngFor="let anio of aniosDisponibles" [value]="anio">
            {{ anio }}
          </ion-segment-button>
        </ion-segment>
      </ion-card-content>
    </ion-card>

    <!-- Resumen General -->
    <ion-card class="resumen-general" *ngIf="reporteAnual">
    
      <ion-card-content>
        <div class="resumen-stats">
          <div class="stat-item total-gastado">
            <div class="stat-valor">{{ formatearMoneda(reporteAnual.totalGastado) }}</div>
            <div class="stat-label">Total Gastado en el A침o</div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  

    <!-- Selector de Visualizaci칩n -->
    <ion-card class="selector-visualizacion">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="eye-outline"></ion-icon>
          Tipo de An치lisis
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-segment [(ngModel)]="tipoVisualizacion" (ionChange)="cambiarTipoVisualizacion($event.detail.value)">
          <ion-segment-button value="tipo">
            <ion-icon name="pricetag-outline"></ion-icon>
            Por Tipo de Egreso
          </ion-segment-button>
          <ion-segment-button value="categoria">
            <ion-icon name="folder-outline"></ion-icon>
            Por Categor칤a
          </ion-segment-button>
        </ion-segment>
      </ion-card-content>
    </ion-card>

  

    <!-- Visualizaci칩n de Gr치ficas -->
    <ion-card class="grafica-container" *ngIf="reporteAnual">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="bar-chart-outline"></ion-icon>
          Visualizaci칩n de Datos
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        

        <!-- Visualizaci칩n de datos de gr치fica -->
        <div class="visualizacion-datos" *ngIf="mostrarDatosGrafica && datosGrafica.length > 0">
          <div class="datos-header">
            <h3>{{ obtenerTituloGrafica() }}</h3>
            <p>A침o {{ anioSeleccionado }} - {{ datosGrafica.length }} elementos</p>
          </div>

          <!-- Gr치fica de barras simple -->
          <div class="grafica-barras-simple">
            <div class="barra-item" *ngFor="let item of datosGrafica; let i = index">
              <div class="barra-label">{{ item.nombre }}</div>
              <div class="barra-container">
                <div 
                  class="barra-fill" 
                  [style.width.%]="obtenerPorcentaje(item.valor, reporteAnual.totalGastado)"
                  [style.background-color]="obtenerColorElemento(i)">
                </div>
                <div class="barra-valor">
                  {{ formatearMoneda(item.valor) }} ({{ obtenerPorcentaje(item.valor, reporteAnual.totalGastado) | number:'1.1-1' }}%)
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensaje cuando no hay datos -->
        <div class="sin-datos" *ngIf="!tieneDatosParaGrafica()">
          <ion-icon name="bar-chart-outline" size="large"></ion-icon>
          <p>No hay datos para mostrar en la visualizaci칩n</p>
        </div>

      </ion-card-content>
    </ion-card>

    <!-- An치lisis por Mes -->
    <ion-card class="analisis-mes" *ngIf="reporteAnual">
      <ion-card-header class="acordeon-header-clickeable" (click)="toggleMeses()">
        <ion-card-title>
          <div class="acordeon-title-content">
            <ion-icon name="calendar-outline"></ion-icon>
            <span>Gastos por Mes</span>
            <ion-icon name="chevron-down-outline" class="acordeon-icon" [class.rotated]="mesesExpandido"></ion-icon>
          </div>
        </ion-card-title>
      </ion-card-header>
      <ion-card-content [class.acordeon-colapsado]="!mesesExpandido">
        <div class="meses-grid">
          <div 
            *ngFor="let mes of obtenerDatosOrdenados(reporteAnual.gastosPorMes)"
            class="mes-item">
            <div class="mes-nombre">{{ mes.nombre }}</div>
            <div class="mes-monto">{{ formatearMoneda(mes.valor) }}</div>
            <div class="mes-barra">
              <div 
                class="mes-barra-fill"
                [style.width.%]="obtenerPorcentaje(mes.valor, reporteAnual.totalGastado)">
              </div>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>


  </div>



  <!-- Estado de carga -->
  <div class="loading" *ngIf="cargando">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Generando reporte...</p>
  </div>
</ion-content>
